-- ìƒ˜í”Œ ì›Œí¬ ë°ì´í„° ìƒì„± (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)
-- ì‹¤ì œ ì‚¬ìš©ìê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰ë˜ë„ë¡ ì¡°ê±´ë¶€ ì²˜ë¦¬

-- ìƒ˜í”Œ í”„ë¡œì íŠ¸ ìƒì„±
INSERT INTO public.projects (id, title, description, status, priority, owner_id, color, created_at, updated_at)
VALUES 
  ('sample-proj-1', 'ì›Œí´ë¦¬ í”Œë«í¼ ê°œë°œ', 'Next.jsì™€ Supabaseë¥¼ í™œìš©í•œ ì—…ë¬´ ê´€ë¦¬ í”Œë«í¼ ê°œë°œ', 'in-progress', 'high', 
   COALESCE((SELECT id FROM public.profiles LIMIT 1), gen_random_uuid()), 
   '#3B82F6', NOW(), NOW()),
  ('sample-proj-2', 'UI/UX ê°œì„ ', 'ì‚¬ìš©ì ê²½í—˜ í–¥ìƒì„ ìœ„í•œ ì¸í„°í˜ì´ìŠ¤ ê°œì„  í”„ë¡œì íŠ¸', 'planning', 'medium', 
   COALESCE((SELECT id FROM public.profiles LIMIT 1), gen_random_uuid()), 
   '#10B981', NOW(), NOW())
ON CONFLICT (id) DO NOTHING;

-- ìƒ˜í”Œ ì›Œí¬ ìƒì„± (ì‚¬ìš©ìê°€ ì¡´ì¬í•  ë•Œë§Œ)
INSERT INTO public.tasks (
  id, title, description, status, priority, type, 
  project_id, assignee_id, reporter_id, 
  due_date, tags, estimated_hours,
  created_at, updated_at
)
SELECT 
  'sample-work-' || generate_series,
  CASE generate_series
    WHEN 1 THEN 'ì›Œí´ë¦¬ ìµœì†Œ ì‘ì—… ë‹¨ìœ„ êµ¬í˜„'
    WHEN 2 THEN 'Supabase ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„'
    WHEN 3 THEN 'Next.js API ë¼ìš°íŠ¸ êµ¬í˜„'
    WHEN 4 THEN 'React ì»´í¬ë„ŒíŠ¸ ê°œë°œ'
    WHEN 5 THEN 'work ëŒ€ì‹œë³´ë“œ UI êµ¬í˜„'
    WHEN 6 THEN 'ì¸ì¦ ì‹œìŠ¤í…œ í†µí•©'
    WHEN 7 THEN 'ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥'
    WHEN 8 THEN 'ëª¨ë°”ì¼ ë°˜ì‘í˜• ë””ìì¸'
    WHEN 9 THEN 'ì„±ëŠ¥ ìµœì í™”'
    WHEN 10 THEN 'ë°°í¬ ë° í…ŒìŠ¤íŠ¸'
    ELSE 'Work ê¸°ëŠ¥ ' || generate_series
  END,
  CASE generate_series
    WHEN 1 THEN 'ì›Œí´ë¦¬ì˜ í•µì‹¬ì¸ work(ìµœì†Œ ì‘ì—… ë‹¨ìœ„)ë¥¼ ì™„ì „íˆ êµ¬í˜„í•©ë‹ˆë‹¤. Supabaseì™€ Next.jsë¥¼ í™œìš©í•˜ì—¬ CRUD ê¸°ëŠ¥ê³¼ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.'
    WHEN 2 THEN 'PostgreSQLê³¼ Supabaseë¥¼ í™œìš©í•œ í™•ì¥ì„± ë†’ì€ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ ì„¤ê³„í•˜ê³  êµ¬í˜„í•©ë‹ˆë‹¤.'
    WHEN 3 THEN 'RESTful API ì—”ë“œí¬ì¸íŠ¸ë¥¼ êµ¬í˜„í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œ ê°„ì˜ ì›í™œí•œ ë°ì´í„° í†µì‹ ì„ ì§€ì›í•©ë‹ˆë‹¤.'
    WHEN 4 THEN 'ì¬ì‚¬ìš© ê°€ëŠ¥í•œ React ì»´í¬ë„ŒíŠ¸ë¥¼ ê°œë°œí•˜ì—¬ ì¼ê´€ëœ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.'
    WHEN 5 THEN 'ì§ê´€ì ì´ê³  íš¨ìœ¨ì ì¸ ì›Œí¬ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.'
    ELSE 'ì›Œí´ë¦¬ í”Œë«í¼ì˜ í•µì‹¬ ê¸°ëŠ¥ì„ ê°œë°œí•©ë‹ˆë‹¤.'
  END,
  CASE (generate_series % 4)
    WHEN 1 THEN 'todo'
    WHEN 2 THEN 'in-progress'
    WHEN 3 THEN 'completed'
    WHEN 0 THEN 'in-review'
  END::task_status,
  CASE (generate_series % 4)
    WHEN 1 THEN 'high'
    WHEN 2 THEN 'medium'
    WHEN 3 THEN 'urgent'
    WHEN 0 THEN 'low'
  END::task_priority,
  CASE (generate_series % 5)
    WHEN 1 THEN 'feature'
    WHEN 2 THEN 'task'
    WHEN 3 THEN 'improvement'
    WHEN 4 THEN 'bug'
    WHEN 0 THEN 'epic'
  END::task_type,
  CASE WHEN generate_series <= 7 THEN 'sample-proj-1' 
       WHEN generate_series <= 10 THEN 'sample-proj-2' 
       ELSE NULL END,
  (SELECT id FROM public.profiles LIMIT 1),
  (SELECT id FROM public.profiles LIMIT 1),
  CASE WHEN generate_series % 3 = 0 THEN NOW() + INTERVAL '7 days'
       WHEN generate_series % 3 = 1 THEN NOW() + INTERVAL '3 days'
       ELSE NOW() + INTERVAL '1 day'
  END,
  CASE (generate_series % 3)
    WHEN 0 THEN ARRAY['urgent', 'frontend']
    WHEN 1 THEN ARRAY['backend', 'database']
    WHEN 2 THEN ARRAY['ui', 'design']
  END,
  CASE WHEN generate_series <= 5 THEN 8.0
       WHEN generate_series <= 8 THEN 4.0
       ELSE 2.0
  END,
  NOW() - INTERVAL '1 day' * (generate_series - 1),
  NOW()
FROM generate_series(1, 12)
WHERE EXISTS (SELECT 1 FROM public.profiles LIMIT 1)
ON CONFLICT (id) DO NOTHING;

-- ìƒ˜í”Œ í”„ë¡œì íŠ¸ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
UPDATE public.projects 
SET progress = (
  SELECT CASE 
    WHEN COUNT(*) = 0 THEN 0
    ELSE ROUND((COUNT(*) FILTER (WHERE status = 'completed')::DECIMAL / COUNT(*)) * 100)
  END
  FROM public.tasks 
  WHERE project_id = projects.id
)
WHERE id IN ('sample-proj-1', 'sample-proj-2');

-- ì˜¤ëŠ˜ í•  ì¼ íƒœê·¸ ì¶”ê°€ (ì¼ë¶€ ì›Œí¬ì—)
UPDATE public.tasks 
SET tags = array_append(tags, 'today')
WHERE id IN ('sample-work-1', 'sample-work-2', 'sample-work-4')
AND EXISTS (SELECT 1 FROM public.profiles LIMIT 1);

-- ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ (ì§„í–‰ì¤‘ì¸ ì›Œí¬ì— ëŒ€í•´)
UPDATE public.tasks 
SET progress = CASE 
  WHEN status = 'completed' THEN 100
  WHEN status = 'in-review' THEN 90
  WHEN status = 'in-progress' THEN 
    CASE WHEN RANDOM() > 0.5 THEN 60 ELSE 30 END
  ELSE 0
END
WHERE id LIKE 'sample-work-%';

-- ì½”ë©˜íŠ¸ ì¶”ê°€ (TODO: í–¥í›„ comments í…Œì´ë¸” ìƒì„± ì‹œ í™œìš©)
-- í˜„ì¬ëŠ” descriptionì— ì—…ë°ì´íŠ¸ ì •ë³´ í¬í•¨

COMMENT ON TABLE public.tasks IS 'ì›Œí´ë¦¬ ì—…ë¬´(work) í…Œì´ë¸” - ìµœì†Œ ì‘ì—… ë‹¨ìœ„ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤';
COMMENT ON COLUMN public.tasks.title IS 'ì›Œí¬ ì œëª©';
COMMENT ON COLUMN public.tasks.description IS 'ì›Œí¬ ìƒì„¸ ì„¤ëª…';
COMMENT ON COLUMN public.tasks.status IS 'ì›Œí¬ ì§„í–‰ ìƒíƒœ';
COMMENT ON COLUMN public.tasks.priority IS 'ì›Œí¬ ìš°ì„ ìˆœìœ„';
COMMENT ON COLUMN public.tasks.type IS 'ì›Œí¬ ìœ í˜•';
COMMENT ON COLUMN public.tasks.tags IS 'ì›Œí¬ íƒœê·¸ ë°°ì—´';
COMMENT ON COLUMN public.tasks.progress IS 'ì›Œí¬ ì§„í–‰ë¥  (0-100)';

-- ê°œë°œìë¥¼ ìœ„í•œ ìœ ìš©í•œ ë·° ìƒì„±
CREATE OR REPLACE VIEW public.work_summary AS
SELECT 
  t.id,
  t.title,
  t.status,
  t.priority,
  t.type,
  t.progress,
  t.due_date,
  t.tags,
  p.title as project_title,
  assignee.first_name || ' ' || assignee.last_name as assignee_name,
  t.created_at,
  t.updated_at,
  -- ì¶”ê°€ ê³„ì‚° í•„ë“œë“¤
  CASE 
    WHEN t.due_date < NOW() AND t.status NOT IN ('completed', 'cancelled') THEN true
    ELSE false
  END as is_overdue,
  CASE 
    WHEN t.due_date::date = CURRENT_DATE OR 'today' = ANY(t.tags) THEN true
    ELSE false
  END as is_today,
  CASE 
    WHEN t.priority IN ('high', 'urgent') THEN true
    ELSE false
  END as is_high_priority
FROM public.tasks t
LEFT JOIN public.projects p ON t.project_id = p.id
LEFT JOIN public.profiles assignee ON t.assignee_id = assignee.id
ORDER BY t.created_at DESC;

COMMENT ON VIEW public.work_summary IS 'ì›Œí¬ ìš”ì•½ ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ë·° - ê°œë°œ ë° ë””ë²„ê¹…ìš©';

-- í†µê³„ë¥¼ ìœ„í•œ í•¨ìˆ˜ ê°œì„ 
CREATE OR REPLACE FUNCTION get_work_stats(user_uuid uuid)
RETURNS json AS $$
DECLARE
  stats json;
BEGIN
  SELECT json_build_object(
    'total', COUNT(*),
    'todo', COUNT(*) FILTER (WHERE status = 'todo'),
    'in_progress', COUNT(*) FILTER (WHERE status = 'in-progress'),
    'in_review', COUNT(*) FILTER (WHERE status = 'in-review'),
    'completed', COUNT(*) FILTER (WHERE status = 'completed'),
    'blocked', COUNT(*) FILTER (WHERE status = 'blocked'),
    'deferred', COUNT(*) FILTER (WHERE status = 'deferred'),
    'cancelled', COUNT(*) FILTER (WHERE status = 'cancelled'),
    'overdue', COUNT(*) FILTER (WHERE due_date < NOW() AND status NOT IN ('completed', 'cancelled')),
    'today', COUNT(*) FILTER (WHERE (due_date::date = CURRENT_DATE OR 'today' = ANY(tags)) AND status NOT IN ('completed', 'cancelled')),
    'high_priority', COUNT(*) FILTER (WHERE priority IN ('high', 'urgent') AND status NOT IN ('completed', 'cancelled')),
    'by_priority', json_build_object(
      'low', COUNT(*) FILTER (WHERE priority = 'low'),
      'medium', COUNT(*) FILTER (WHERE priority = 'medium'),
      'high', COUNT(*) FILTER (WHERE priority = 'high'),
      'urgent', COUNT(*) FILTER (WHERE priority = 'urgent')
    ),
    'by_type', json_build_object(
      'task', COUNT(*) FILTER (WHERE type = 'task'),
      'feature', COUNT(*) FILTER (WHERE type = 'feature'),
      'bug', COUNT(*) FILTER (WHERE type = 'bug'),
      'improvement', COUNT(*) FILTER (WHERE type = 'improvement'),
      'epic', COUNT(*) FILTER (WHERE type = 'epic')
    )
  ) INTO stats
  FROM public.tasks 
  WHERE assignee_id = user_uuid OR reporter_id = user_uuid;
  
  RETURN stats;
END;
$$ language plpgsql security definer;

COMMENT ON FUNCTION get_work_stats IS 'ì‚¬ìš©ìë³„ ì›Œí¬ í†µê³„ë¥¼ JSONìœ¼ë¡œ ë°˜í™˜ - ëŒ€ì‹œë³´ë“œìš©';

-- ì¸ë±ìŠ¤ ì¶”ê°€ (ì„±ëŠ¥ ìµœì í™”)
CREATE INDEX IF NOT EXISTS idx_tasks_today 
ON public.tasks (assignee_id, due_date) 
WHERE due_date::date = CURRENT_DATE OR 'today' = ANY(tags);

CREATE INDEX IF NOT EXISTS idx_tasks_priority_status 
ON public.tasks (priority, status) 
WHERE status NOT IN ('completed', 'cancelled');

CREATE INDEX IF NOT EXISTS idx_tasks_overdue 
ON public.tasks (due_date, status) 
WHERE due_date < NOW() AND status NOT IN ('completed', 'cancelled');

-- ìƒ˜í”Œ ë°ì´í„° ìƒì„± ì™„ë£Œ
SELECT 'Sample work data created successfully! ğŸ‰' as message;